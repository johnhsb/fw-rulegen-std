# 시스템 아키텍처

## 개요

방화벽 정책 추천 시스템은 모듈화된 구조로 설계되어 있으며, 각 모듈은 특정 기능을 담당합니다. 시스템은 Flask 웹 프레임워크를 기반으로 하며, 로그 수집, 분석, 정책 생성의 파이프라인을 구성합니다.

## 시스템 구성도

```
+------------------+     +------------------+     +------------------+
|                  |     |                  |     |                  |
|  웹 브라우저     |     |  주니퍼 방화벽   |     |  외부 시스템     |
|                  |     |                  |     |                  |
+--------+---------+     +--------+---------+     +--------+---------+
         |                        |                        |
         | HTTPS                  | Syslog (UDP)           | API
         |                        |                        |
+--------v-------------------------v------------------------v---------+
|                                                                     |
|                         Flask Application (app.py)                  |
|                                                                     |
| +-------------------------+  +--------------------------+          |
| |     웹 인터페이스      |  |    Syslog 서버          |          |
| |  (templates/*.html)     |  |  (syslog_server.py)     |          |
| +-------------------------+  +--------------------------+          |
|                                                                     |
| +-------------------------+  +--------------------------+          |
| |     인증 모듈          |  |    로그 파서             |          |
| |    (auth.py)           |  |   (log_parser.py)        |          |
| +-------------------------+  +--------------------------+          |
|                                                                     |
| +-------------------------+  +--------------------------+          |
| |   트래픽 분석기        |  |    정책 생성기           |          |
| | (traffic_analyzer.py)   |  | (policy_generator.py)    |          |
| +-------------------------+  +--------------------------+          |
|                                                                     |
+---------------------------------------------------------------------+
         |                        |                        |
         | 파일 시스템            | 데이터베이스           | 외부 API
         |                        | (추후 확장)            |
+--------v---------+     +--------v---------+     +--------v---------+
|                  |     |                  |     |                  |
|   로그 파일      |     |   분석 결과      |     |   시각화 파일    |
|   (logs/)        |     |   (output/)      |     |   (static/)      |
|                  |     |                  |     |                  |
+------------------+     +------------------+     +------------------+
```

## 핵심 컴포넌트

### 1. 웹 애플리케이션 (app.py)

메인 Flask 애플리케이션으로 다음 역할을 수행합니다:

- **라우팅 관리**: URL 엔드포인트와 뷰 함수 매핑
- **상태 관리**: 전역 상태 및 세션 관리
- **서비스 오케스트레이션**: 각 모듈 간 조정

주요 엔드포인트:
- `/`: 대시보드
- `/upload`: 로그 파일 업로드
- `/analyze`: 로그 분석 실행
- `/policies`: 정책 추천 결과
- `/config`: 주니퍼 설정 생성
- `/syslog`: Syslog 서버 관리

### 2. 인증 모듈 (auth.py)

사용자 인증 및 세션 관리를 담당합니다:

- **사용자 관리**: JSON 파일 기반 사용자 저장소
- **비밀번호 해싱**: SHA-256 암호화
- **세션 보안**: Flask-Session을 통한 서버사이드 세션

### 3. 로그 파서 (log_parser.py)

주니퍼 방화벽 로그를 파싱하여 구조화된 데이터로 변환합니다:

- **정규식 기반 파싱**: RT_FLOW 세션 로그 추출
- **IPv4/IPv6 지원**: 멀티 프로토콜 지원
- **데이터 정규화**: DataFrame 형태로 변환

핵심 기능:
```python
def parse_log_line(self, line):
    # 로그 라인 파싱 및 구조화
    # IP 주소 유효성 검증
    # 프로토콜 매핑
```

### 4. 트래픽 분석기 (traffic_analyzer.py)

로그 데이터를 분석하여 트래픽 패턴을 식별합니다:

- **DBSCAN 클러스터링**: 비지도 학습 기반 패턴 발견
- **IP 범위 최적화**: CIDR 블록 자동 계산
- **시각화 생성**: Sankey 다이어그램, 3D 플롯

주요 메서드:
```python
def cluster_traffic_patterns(self):
    # DBSCAN 클러스터링 수행
    # IPv4/IPv6 분리 처리
    # 메모리 최적화

def visualize_traffic_sankey(self):
    # Sankey 다이어그램 생성
    # 트래픽 흐름 시각화
```

### 5. 정책 생성기 (policy_generator.py)

클러스터링 결과를 기반으로 방화벽 정책을 생성합니다:

- **정책 템플릿**: 주니퍼 설정 형식 생성
- **주소집합 관리**: 효율적인 IP 그룹화
- **애플리케이션 정의**: 포트/프로토콜 매핑

### 6. Syslog 서버 (syslog_server.py)

실시간 로그 수집 및 자동 분석을 수행합니다:

- **UDP 서버**: 표준 Syslog 프로토콜 지원
- **자동 분석**: 주기적 배치 처리
- **필터링**: 장비별 로그 필터링

## 데이터 흐름

### 1. 로그 수집 단계
```
방화벽 → Syslog/파일 업로드 → 로그 파서 → 정규화된 데이터
```

### 2. 분석 단계
```
정규화된 데이터 → 필터링 → DBSCAN 클러스터링 → 트래픽 패턴
```

### 3. 정책 생성 단계
```
트래픽 패턴 → 정책 추천 → 주니퍼 설정 생성
```

## 기술 스택

### 백엔드
- **Python 3.8+**: 코어 언어
- **Flask**: 웹 프레임워크
- **scikit-learn**: DBSCAN 클러스터링
- **pandas**: 데이터 처리
- **numpy**: 수치 연산

### 프론트엔드
- **Bootstrap 5**: UI 프레임워크
- **jQuery**: DOM 조작
- **Plotly.js**: 시각화
- **Chart.js**: 차트 생성

### 데이터 저장
- **파일 시스템**: 로그 및 결과 저장
- **JSON**: 설정 및 메타데이터
- **세션 파일**: Flask-Session

## 보안 고려사항

### 1. 인증 및 인가
- 세션 기반 인증
- 비밀번호 해싱
- CSRF 보호

### 2. 네트워크 보안
- HTTPS 지원
- SSL/TLS 인증서
- 포트 접근 제어

### 3. 데이터 보안
- 업로드 파일 크기 제한
- 경로 탐색 방지
- 입력 값 검증

## 성능 최적화

### 1. 메모리 관리
- 배치 처리로 메모리 사용량 제한
- 가비지 컬렉션 명시적 호출
- 스트리밍 기반 파일 처리

### 2. 처리 최적화
- 멀티스레딩 Syslog 서버
- 비동기 분석 처리
- 인덱싱 최적화

### 3. 캐싱
- 정적 파일 캐싱
- 분석 결과 캐싱
- 세션 데이터 캐싱

## 확장성 고려사항

### 1. 수평적 확장
- 무상태 설계
- 세션 공유 가능
- 로드 밸런서 지원

### 2. 데이터베이스 통합
- ORM 사용 준비
- 마이그레이션 지원
- 백업/복원 기능

### 3. API 확장
- RESTful API 설계
- 인증 토큰 지원
- 버전 관리

## 모니터링 및 로깅

### 1. 애플리케이션 로깅
- 구조화된 로그 포맷
- 로그 레벨 관리
- 로그 로테이션

### 2. 시스템 모니터링
- 리소스 사용량 추적
- 에러 추적
- 성능 메트릭

### 3. 알림 시스템
- 이메일 알림 (추후 구현)
- Webhook 지원 (추후 구현)
- 대시보드 알림

## 개발 가이드라인

### 1. 코딩 표준
- PEP 8 스타일 가이드 준수
- 명확한 함수/변수 이름
- 타입 힌트 사용

### 2. 테스트
- 단위 테스트
- 통합 테스트
- 부하 테스트

### 3. 문서화
- Docstring 작성
- API 문서화
- 사용자 가이드

## 추후 개선 방향

1. **데이터베이스 통합**: SQLAlchemy + PostgreSQL
2. **비동기 처리**: Celery + Redis
3. **컨테이너화**: Docker + Kubernetes
4. **마이크로서비스**: 모듈별 분리
5. **AI/ML 강화**: 고급 분석 알고리즘
6. **멀티 벤더 지원**: 다양한 방화벽 브랜드
