{% extends "base.html" %}

{% block title %}로그 업로드 - 방화벽 정책 추천 시스템{% endblock %}

{% block content %}
<style>
    input[type="file"]::file-selector-button {
        background-color: #2d2d2d;
        border: 1px solid #444;
        color: #e0e0e0;
        padding: 0.375rem 0.75rem;
        margin-right: 0.5rem;
    }
    input[type="file"]::file-selector-button:hover {
        background-color: #3d3d3d;
    }
    
    .progress {
        background-color: #2d2d2d;
    }
    
    .btn:disabled {
        opacity: 0.65;
    }
    
    #uploadStatus {
        color: #adb5bd;
    }
    
    .card-body ul, .card-body ol {
        color: #e0e0e0;
    }
    .card-body li {
        margin-bottom: 0.5rem;
    }
</style>
<h2>로그 파일 업로드</h2>
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">로그 파일 선택</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="logfile" class="form-label">로그 파일 선택 (여러 파일 선택 가능)</label>
                        <input class="form-control" type="file" id="logfile" name="logfile" multiple required>
                        <div class="form-text">주니퍼 방화벽 로그 파일을 선택하세요 (최대 200MB).</div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <button type="submit" class="btn btn-primary" id="uploadBtn">업로드</button>
                        <span id="uploadStatus" class="text-muted"></span>
                    </div>
                </form>
                
                <div class="progress mt-3 d-none" id="progressBar">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div class="alert alert-success mt-3 d-none" id="successMessage">
                    로그 파일이 성공적으로 업로드되었습니다.
                </div>
                
                <div class="alert alert-danger mt-3 d-none" id="errorMessage"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">업로드 후 작업</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/analyze" class="btn btn-success" id="analyzeBtn" disabled>로그 분석 시작</a>
                </div>
                <div class="mt-3">
                    <p>로그 파일 업로드 후 분석을 시작하여 트래픽 패턴을 확인하고 정책 추천을 받으세요.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">도움말</h5>
            </div>
            <div class="card-body">
                <h6>지원되는 로그 형식</h6>
                <ul>
                    <li>주니퍼 방화벽 Syslog 형식 로그</li>
                    <li>RT_FLOW 세션 로그 (CREATE/CLOSE)</li>
                </ul>
                
                <h6>파일 요구사항</h6>
                <ul>
                    <li>최대 파일 크기: 200MB</li>
                    <li>지원 형식: 텍스트 파일 (.log, .txt)</li>
                </ul>
                
                <h6>프로세스</h6>
                <ol>
                    <li>로그 파일 선택</li>
                    <li>업로드 버튼 클릭</li>
                    <li>업로드 완료 후 분석 시작</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 로그 파일 업로드 폼 제출 처리
    $('#uploadForm').submit(function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        var files = $('#logfile')[0].files;
        
        if (files.length === 0) {
            $('#errorMessage').text('파일을 선택해주세요.').removeClass('d-none');
            return;
        }
        
        // 진행 표시줄 초기화 및 표시
        $('#progressBar').removeClass('d-none');
        $('.progress-bar').css('width', '0%');
        $('#successMessage').addClass('d-none');
        $('#errorMessage').addClass('d-none');
        $('#uploadBtn').prop('disabled', true);
        $('#uploadStatus').text('업로드 중...');
        
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        var percent = Math.round((e.loaded / e.total) * 100);
                        $('.progress-bar').css('width', percent + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                $('#successMessage').removeClass('d-none');
                $('#uploadStatus').text('완료');
                $('#analyzeBtn').prop('disabled', false);
                $('.progress-bar').css('width', '100%');
            },
            error: function(xhr) {
                var errorMsg = '업로드 중 오류가 발생했습니다.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                $('#errorMessage').text(errorMsg).removeClass('d-none');
                $('#uploadStatus').text('실패');
                $('.progress-bar').css('width', '0%');
            },
            complete: function() {
                $('#uploadBtn').prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}
